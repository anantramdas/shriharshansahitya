<html>

<head>
    <!-- basic -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- mobile metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="viewport" content="width=device-width, initial-scale=0.86, maximum-scale=5.0, minimum-scale=0.86">
    <!-- site metas -->
    <title>Editor</title>
    <script type="text/javascript" src="../booklist.js"></script>
    <script type="text/javascript" src="code.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Laila&display=swap');
    </style>
    <script>
        const LINELIMIT = 20;
        let bookLineMargin = 10;
        var rawData = {}; //contains books text
        let contentDiv;
        let pageImage, movePrev, moveNext, loadMore, indicator;
        let lines;
        let startLineIndex;
        let lineMap;
        let endLineIndex;
        let pageChunkNo;
        let textRange;
        var pages, pageIndex;

        function onBodyLoad() {
            var str = '';
            initVariables();
            for (var bookId in booksList) {
                let _book = booksList[bookId];
                _book.id = bookId;
                str += `<div id='${bookId}' class='bookBtn' onclick='downloadBook(this.id)'>${_book.title}</div>`
            }
            if (isLocalHost) {
                downloadBook(); //remove this
                return;
            }
            contentDiv.innerHTML = str;
        }

        function initVariables() {
            contentDiv = document.getElementById('content');
            pageImage = document.getElementById('pageImage');
            movePrev = document.getElementById('movePrev');
            moveNext = document.getElementById('moveNext');
            loadMore = document.getElementById('loadMore');
            indicator = document.getElementById('indicator');
        }
        
        function downloadBook(id) {
            // id = 'shri_prem_ramayan'; //remove later
            id = 'atma_vishleshan'; //remove later
            activeBook = booksList[id];
            lineMap = {};
            if (!isLocalHost) {
                openFullscreen();
            }
            loadJS('raw_books/' + id + '.js', function () {
                pages = loadImages();
                onDownloadComplete(id)
            });
            contentDiv.innerHTML = '<div id="loaderBox"><div id="loader"></div></div>';
        }

        function onDownloadComplete(id) {
            lines = rawData[id].split('\n');
            moveTo(0);
        }

        function moveTo(index) {
            if (index < 0) {
                alert('First Page');
            } else if (index >= pages.length) {
                alert('Last Page');
            } else {
                endLineIndex = startLineIndex = -1;
                pageChunkNo = 1;
                changePageImage(index);
                loadText(index);
                renderLines();
                scrollToTop();
                pageIndex = index;
            }
        }

        function scrollToTop() {
            document.querySelectorAll('.scroll').forEach(div => div.scrollTo(0, 0));
        }

        function changePageImage(index) {
            //pageNumber.childNodes[1].innerHTML = pageIndex + 1;
            pageImage.src = pages[index];
        }

        function loadText(_pageIndex) {
            let pageNo = _pageIndex + 1;
            textRange = lineMap[pageNo];
            if (!textRange) {
                let startIndex = 0, endIndex = lines.length - 1;
                for(let page in lineMap) {
                    if (page < pageNo) {
                        startIndex = lineMap[page].end + 1;
                    } else {
                        endIndex = lineMap[page].start - 1;
                        break;
                    }
                }
                textRange = {start: startIndex, end: endIndex};
                loadMore.innerHTML = 'Load more';
                loadMore.classList.remove('reset');
                indicator.classList.remove('correct');
            } else {
                loadMore.classList.add('reset');
                indicator.classList.add('correct');
                loadMore.innerHTML = 'Reset';
                textRange = {start: textRange.start, end: textRange.end}; //make copy
            }
        }
        //TODO - add a tick and cross sign on image to show page lines are set or not and also to reset on click
        function renderLines() {
            var str = '';
            for (let lineIndex = textRange.start + (pageChunkNo - 1) * LINELIMIT; lineIndex < textRange.start + pageChunkNo * LINELIMIT && lineIndex <= textRange.end; lineIndex++) {
                let line = lines[lineIndex];
                let lineNo = lineIndex - textRange.start;
                let lineHtml = `<div class='line' onclick='selectLine(${lineNo})'>${line}</div><br>`;
                str += `<div class='linerow'><div class='lineNo'>${lineNo + 1}</div>${lineHtml}</div>`;
            }
            
            if (pageChunkNo == 1) {
                contentDiv.innerHTML = `<div id="bookContent">${str}</div>`;
            } else {
                contentDiv.innerHTML += `<div id="bookContent">${str}</div>`;
            }
            loadMore.classList.remove('hidden');
        }

        function loadMoreLines() {
            if (loadMore.classList.contains('reset')) {
                if (confirm("Do you want to reset this page?") == true) {
                    startLineIndex = endLineIndex = -1;
                    saveText();
                    moveTo(pageIndex);
                }
            } else {
                pageChunkNo++;
                renderLines();
                if (pageChunkNo * LINELIMIT >= lines.length) {
                    loadMore.classList.add('hidden');
                }
            }
        }

        function saveText() {
            if (startLineIndex > -1 && endLineIndex > -1)
                lineMap[pageIndex + 1] = {start: textRange.start + startLineIndex, end: textRange.start + endLineIndex};
            else
                delete lineMap[pageIndex + 1];
        }
        
        function showButtons() {
            movePrev.classList.remove('hidden');
            moveNext.classList.remove('hidden');
            indicator.classList.remove('hidden');
        }
        var btnTimer;
        function onPageImageClick(e) {
            movePrev.classList.add('hidden');
            moveNext.classList.add('hidden');
            indicator.classList.add('hidden');
            clearTimeout(btnTimer);
            btnTimer = setTimeout(showButtons, 1000);
            // if (isEditing)
            // generateMarker(e.clientX, e.clientY);
        }
        
        function selectLine(lineIndex) {
            let linesDiv = document.querySelectorAll('.line');
            if (startLineIndex == -1 || startLineIndex > lineIndex)
                startLineIndex = lineIndex;
            else if (startLineIndex == lineIndex)
                startLineIndex = -1;
            if (startLineIndex > -1) {
                deselectActives();
                endLineIndex = lineIndex;
                for (let i = startLineIndex; i <= endLineIndex; i++) {
                    linesDiv[i].classList.add('activeLine');
                }
                indicator.classList.add('correct');
            }
            else {
                endLineIndex = -1;
                indicator.classList.remove('correct');
                deselectActives();
            }
            saveText();
        }
        function deselectActives() {
            document.querySelectorAll('.activeLine').forEach((line) => line.classList.remove('activeLine'));
        }
    </script>
    <link rel="stylesheet" href="editor_style.css">
</head>

<body onload="onBodyLoad()">
    <div id="screen">
        <div id="page" class="scroll">
            <img id="pageImage" alt="Book Page" onclick="onPageImageClick(event)" style="background-color: white;" src="raw_books/book_icon.png" />
            <button id="movePrev" onclick="moveTo(pageIndex - 1)"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAAArklEQVR4nO3Y0QqCQBRF0f2FZTGDD/bvQUEFfYKBMjAQhD537uUs8N3DVnAEs9ROwBN4A4WgRmAGln61MeFHLMCLBCNm4EwgdWPEB5gIxCNUuIQKl1DhEipcQoVLqKj+ABRRM5QYdg5F7bAUyj3DiFRDhiyPFv3/09bLfiGg4jGiisuIKi4jqriMKJdR5TKqXEZVqjLjzuHsSJIxN4L6HfMgsPY4XXuNw79vxoyvFeVU7Pycczv1AAAAAElFTkSuQmCC"></button>
            <button id="moveNext" onclick="moveTo(pageIndex + 1)"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAqklEQVR4nO3ZQQrCQBBE0e8JDdJDFvHsLgwKQW8QQQmM4MLsq5t6ILhM8SeQKJhJacATuAEDSR2AB/DunxUYSWr5GZJ6zKlffIkx8WfMCziTUHiMqHAZUeEyosJlRLmMKpdR5TKqSpUZd17OBoqMmSky5EoyJY5W27nZJxLxCBUuocIlVLiECpdQ4RIqmh8ARbQKJY5V/gydK4zY3CuM+B6t7UeCS/9uVtUHEhTs/ZXHkMQAAAAASUVORK5CYII="></button>
            <div id="indicator"></div>
        </div>
        <div id="editor" class="scroll">
            <div id="content"></div>
            <button id="loadMore" class="hidden" onclick="loadMoreLines()">Load more</button>
        </div>
    </div>
</body>

</html>